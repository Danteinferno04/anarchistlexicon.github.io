<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
{% include _head.html %}
</head>

<body class="post-index">

{% include _browser-upgrade.html %}

{% include _navigation.html %}

{% if page.image.feature %}
  <div class="image-wrap">
  <img src=
    {% if page.image.feature contains 'http' %}
      "{{ page.image.feature }}"
    {% else %}
      "{{ site.url }}/images/{{ page.image.feature }}"
    {% endif %}
  alt="{{ page.title }} feature image">
  {% if page.image.credit %}
    <span class="image-credit">Photo Credit: {% if page.image.creditlink %}<a href="{{ page.image.creditlink }}">{% endif %}{{ page.image.credit }}{% if page.image.creditlink %}</a>{% endif %}</span>
  {% endif %}
  </div><!-- /.image-wrap -->
{% endif %}

<div id="main" role="main">
  <div class="article-author-side">
    {% include _author-bios.html %}
  </div>
  <div id="index">
    <h1>{{ page.title }}</h1>

    <div id="posts_tagged"></div>
    <script type="text/javascript">
      function enumeratePosts(order, printer, continuation)
      {
          function getPosts() {
              return $.getJSON("{{site.url}}/posts_metadata.json");
          }

          getPosts().done(function(j) {
              var posts = [];
              $.each(j, function() {
                  posts.push(this);
              });

              posts.sort(order);

              $.each(posts, printer);

              continuation(posts);
          });
      }

      document.addEventListener("DOMContentLoaded", function(event)
      {
          var output = $("#posts_tagged");
          output.html("<br/>");

          var order = function(a, b) {
              if (a.title < b.title) return -1;
              if (a.title > b.title) return 1;
              return 0;
          }


          function unique(array) {
              var a = array.concat();
              for(var i=0; i<a.length; ++i) {
                  for(var j=i+1; j<a.length; ++j) {
                      if(a[i] === a[j])
                          a.splice(j--, 1);
                  }
              }
              return a;
          };

          var tags = []
          var posts = []
          var collect_tags = function(idx, post) {
              $.merge(tags, post.tags);
              tags = unique(tags.concat(post.tags));
              posts += post;
          }

          enumeratePosts(order, collect_tags, function(posts) {

    //    <ul>
    //      <li><a href="#{ tag.slug }">{ tag.name }</a></li>
    //    </ul>
    //    <a name="{ tag.slug }"/>

              var print_tag_link = function(tag) {
                  output.append("<li><a href=\"#" + tag + "\">" + tag + "</a></li>");
              }

              output.append("<ul>");
              tags.map(function(tag) {
                  print_tag_link(tag);
              });
              output.append("</ul>");


              var print_tag_hr = function(tag) {
                  output.append("<br><h1>" + tag + "</h1><a name=" + tag + "/><hr>");
              }

              var print_post = function(post) {
                  function stripHtml(str) {
                      var temp = document.createElement('DIV');
                      temp.innerHTML = str;
                      return temp.textContent || temp.innerText;
                  }

                  var stripped_excerpt = stripHtml(post.excerpt);
                  if (stripped_excerpt.length + 3 >= 160)
                      stripped_excerpt = stripped_excerpt.substring(0, 160-3) + "...";

                  // Articles
                  output.append("<article>\n" +
                                "  <h2><a href=\"{{ site.url }}" + post.url + "\" title=\"" + post.title + "\">" + post.title + "</a></h2>\n" +
                                "  <p>" + stripped_excerpt + "</p>\n" +
                                "</article>");
              }

              tags.map(function(tag) {
                  print_tag_hr(tag);
                  posts.map(function(post) {
                      if ($.inArray(tag, post.tags) > -1) {
                          print_post(post);
                      }
                  });
              });
          });
      });
    </script>

  </div><!-- /#index -->
</div><!-- /#main -->

<div class="footer-wrap">
  <footer>
    {% include _footer.html %}
  </footer>
</div><!-- /.footer-wrap -->

{% include _scripts.html %}

</body>
</html>
